<!DOCTYPE html>
<html>

  <head>
    <title>DOD Connection Client</title>
  </head>

  <body>

    <p/>
    
    <canvas id="moving_map" width="800" height="800" style="border:0px solid #FF0000;"></canvas> 
    <p>Forward proximity (m):</p><p id=proximity></p>

    <p><span style="font-weight:bold">DOD says:</span></p>
    <div id="output"></div>

    <script>

      var last_message = "";
      var too_close = 0;
      var host = "ws://raspberrypi:8080/ws";
      var socket = new WebSocket(host);

      if(socket) {
        socket.onopen = function() {

          document.onkeydown = function KeyCheck(event) {

            var KeyID = event.which; 

            switch(KeyID) {
              case 16:
                socket.send("robot|drivetrain|stop");
                socket.send("robot|drivetrain|coast");
                last_message = "robot|drivetrain|coast";
                break;
              case 37:
                if (last_message != "robot|drivetrain|left"){
                  last_message = "robot|drivetrain|left";
                  socket.send(last_message);
                }
                break;
              case 38:
                if (last_message != "robot|drivetrain|forward"){
                  last_message = "robot|drivetrain|forward";
                  socket.send(last_message);
                }
                break;
              case 39:
                if (last_message != "robot|drivetrain|right"){
                  last_message = "robot|drivetrain|right";
                  socket.send(last_message);
                }
                break;
              case 40:
                if (last_message != "robot|drivetrain|reverse"){
                  last_message = "robot|drivetrain|reverse";
                  socket.send(last_message);
                }
                break;
              case 67:
                socket.send("robot|drivetrain|center");
                break;
              case 68:
                socket.send("robot|forward_range|get");
                break;
              }
            }

          document.onkeyup = function KeyCheck(event) {

            var KeyID = event.which; 

            switch(KeyID) {
              case 37:
                last_message = "robot|drivetrain|center";
                socket.send(last_message);
                break;
              case 38:
                last_message = "robot|drivetrain|coast";
                socket.send(last_message);
                break;
              case 39:
                last_message = "robot|drivetrain|center";
                socket.send(last_message);
                break;
              case 40:
                last_message = "robot|drivetrain|coast";
                socket.send(last_message);
                break;
              }
            }

          }

          socket.onmessage = function(msg) {
              showServerResponse(msg.data);
          }
          socket.onclose = function() {
              showServerResponse("Connection closed by server.");
          }
      } else {
          console.log("Invalid socket.");
      }

      function showServerResponse(txt) {
          if (txt.split("|")[1] == "forward_range"){
            var dist = parseFloat(txt.split("|")[2]);
            if (dist < 0.25){
                if (too_close == 0){
                    document.getElementById("proximity").style.color="red";
                    too_close = 1;
                }
            } else {
                if (too_close == 1){
                    document.getElementById("proximity").style.color="black";
                    too_close = 0;
                }
            }
            document.getElementById("proximity").innerHTML = dist.toFixed(3);
          } else {
            var p = document.createElement('p');
            p.innerHTML = txt;
            document.getElementById('output').appendChild(p);
          }
      }   

    </script>

    <script>
    
        // Script for updating moving map.  Currently hacked to generate random
        // values for the density at each point in the grid.
    
        RGBToHex = function(r,g,b){
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        // HACK
        var density = 0.5;    
 
        var i = 0; 
        var j = 0;
        var x = 0;
        var y = 0;
        var mainMatrix = Array(200);
        for (i = 0; i < 200; i++){
            mainMatrix[i] = Array(200);
        } 

        // Initialize drawing area
        var c = document.getElementById("moving_map");
        var ctx = c.getContext("2d");
        ctx.clearRect(0, 0, ctx.width, ctx.height);
        ctx.fillStyle = "#FF0000";

        // Update the display every 500 ms.
        var nIntervId = setInterval(updateDrawing,500);
   
        function updateDrawing(){

            // Update the matrix
            for (i = 0; i < 200; i++){
                for (j = 0; j < 200; j++){
                    if (Math.random() < density){
                        mainMatrix[i][j] = 255 - Math.floor(Math.random()*255);
                    } else { 
                        mainMatrix[i][j] = 255;
                    }
                }
            }
          
            // Update the display 
            ctx.clearRect(0, 0, 800, 800);  //ctx.width, ctx.height);
            for (i = 0; i < 200; i++){
                for (j = 0; j < 200; j++){
                    ctx.fillStyle=RGBToHex(255,mainMatrix[i][j],mainMatrix[i][j]);
                    ctx.fillRect(i*4,j*4,4,4);
                }
            }

            // Draw the robot on the display
            var robot_icon = new Image();
            robot_icon.src = "robot-icon.png";
            ctx.drawImage(robot_icon,400,400) 
        }


    </script> 

  </body>
</html>

